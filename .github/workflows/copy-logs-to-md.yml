name: Sync artifacts and platform reports

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout source repo
      # ------------------------------------------------------------
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Setup SSH (source + destination accounts)
      # ------------------------------------------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_SOURCE }}" > ~/.ssh/id_source
          echo "${{ secrets.SSH_KEY_DEST }}" > ~/.ssh/id_dest
          chmod 600 ~/.ssh/id_source ~/.ssh/id_dest

          cat <<EOF >> ~/.ssh/config
          Host github-source
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_source
            IdentitiesOnly yes

          Host github-dest
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_dest
            IdentitiesOnly yes
          EOF

          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ------------------------------------------------------------
      # Generate Azure markdown for AMD
      # ------------------------------------------------------------
      - name: Generate Azure markdown for AMD
        run: |
          AZURE_LOG_AMD=$(find . -type f -iname "azure-gardener_prod-amd64*platform.test.log" | head -n 1)
          [ -n "$AZURE_LOG_AMD" ] || { echo "Azure log AMD not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$AZURE_LOG_AMD" \
            /tmp/1877.0.azure-amd64.md \
            Azure

      # ------------------------------------------------------------
      # Generate Azure markdown for ARM
      # ------------------------------------------------------------
      - name: Generate Azure markdown for ARM
        run: |
          AZURE_LOG_ARM=$(find . -type f -iname "azure-gardener_prod-arm64*platform.test.log" | head -n 1)
          [ -n "$AZURE_LOG_ARM" ] || { echo "Azure log ARM not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$AZURE_LOG_ARM" \
            /tmp/1877.0.azure-arm64.md \
            Azure          

      # ------------------------------------------------------------
      # Generate AWS markdown for AMD
      # ------------------------------------------------------------
      - name: Generate AWS markdownm for AMD
        run: |
          AWS_LOG_AMD=$(find . -type f -iname "aws-gardener_prod-amd64*platform.test.log" | head -n 1)
          [ -n "$AWS_LOG_AMD" ] || { echo "AWS log AMD not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$AWS_LOG_AMD" \
            /tmp/1877.0.aws-amd64.md \
            AWS

      # ------------------------------------------------------------
      # Generate AWS markdown for ARM
      # ------------------------------------------------------------
      - name: Generate AWS markdown for ARM
        run: |
          AWS_LOG_ARM=$(find . -type f -iname "aws-gardener_prod-arm64*platform.test.log" | head -n 1)
          [ -n "$AWS_LOG_ARM" ] || { echo "AWS log ARM not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$AWS_LOG_ARM" \
            /tmp/1877.0.aws-arm64.md \
            AWS

      # ------------------------------------------------------------
      # Generate GCP markdown
      # ------------------------------------------------------------
      - name: Generate GCP markdown for AMD
        run: |
          GCP_LOG_AMD=$(find . -type f -iname "gcp-gardener_prod-amd64*platform.test.log" | head -n 1)
          [ -n "$GCP_LOG_AMD" ] || { echo "GCP log AMD not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$GCP_LOG_AMD" \
            /tmp/1877.0.gcp-amd64.md \
            GCP

      # ------------------------------------------------------------
      # Generate GCP markdown
      # ------------------------------------------------------------
      - name: Generate GCP markdown for ARM
        run: |
          GCP_LOG_ARM=$(find . -type f -iname "gcp-gardener_prod-arm64*platform.test.log" | head -n 1)
          [ -n "$GCP_LOG_ARM" ] || { echo "GCP log ARM not found"; exit 1; }

          python3 scripts/log_to_md.py \
            "$GCP_LOG_ARM" \
            /tmp/1877.0.gcp-arm64.md \
            GCP

      # ------------------------------------------------------------
      # Clone destination repo (SSH)
      # ------------------------------------------------------------
      - name: Clone destination repo
        run: |
          git clone git@github-dest:saubhik4gh/fancytest.git dest-repo

      # ------------------------------------------------------------
      # Copy directories and reports
      # ------------------------------------------------------------
      - name: Copy artifacts and reports
        run: |
          cp /tmp/1877.0.*.md dest-repo/archive/1877/

      # ------------------------------------------------------------
      # Commit and push (only if changes exist)
      # ------------------------------------------------------------
      - name: Commit and push
        run: |
          cd dest-repo
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep .; then
            git add .
            git commit -m "Sync package-oras and platform test reports (1877.0, amd64)"
            git push origin main
          else
            echo "No changes to push"
          fi
